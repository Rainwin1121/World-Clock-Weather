<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒå®æ—¶æ—¶é—´ç›‘æ§ç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥ Leaflet åœ°å›¾åº“ CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- å¼•å…¥ Google Fonts (ç§‘æŠ€æ„Ÿå­—ä½“) -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- å¼•å…¥ Tailwind CSS ç”¨äºå¿«é€Ÿå¸ƒå±€ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-color: #0b0c10;
            --text-color: #66fcf1;
            --accent-color: #45a29e;
            --highlight-color: #ff0055; /* èµ«å°”è¾›åŸºé«˜äº®è‰² */
        }

        body, html {
            height: 100%;
            margin: 0;
            background-color: var(--bg-color);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨æ¡ */
            color: white;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            background: #0b0c10;
        }

        /* è‡ªå®šä¹‰åœ°å›¾æ ‡è®°æ ·å¼ - ç°ä»£åŒ–æ¯›ç»ç’ƒé£æ ¼ */
        .city-label {
            /* é€æ˜èƒŒæ™¯ + æ¨¡ç³Šæ»¤é•œ (Glassmorphism) */
            background: rgba(20, 25, 30, 0.25); 
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            
            /* è¾¹æ¡†æ”¹ä¸ºæ›´æ·¡çš„æ•´ä½“å¾®å…‰ */
            border: 1px solid rgba(100, 255, 218, 0.2);
            
            /* ç°ä»£åœ†è§’ */
            border-radius: 16px;
            
            padding: 6px 10px;
            white-space: nowrap;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* é˜´å½±ä¹Ÿç¨å¾®æŸ”å’Œä¸€ç‚¹ */
            transition: all 0.3s ease;
            text-align: center;
            
            /* Flex å¸ƒå±€å®ç°ç´§å‡‘æ’åˆ— */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0px; 
        }

        .city-label strong {
            display: block;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 1px;
            margin-bottom: 0px; 
            line-height: 1.2;
        }

        .city-label span.time-display {
            font-size: 22px; 
            color: var(--text-color);
            font-weight: bold;
            display: block;
            line-height: 1.1; 
            margin: 1px 0;    
            text-shadow: 0 0 5px rgba(102, 252, 241, 0.4);
        }

        .city-label .date-info {
            font-size: 10px;
            color: #aaa;
            line-height: 1.2;
            margin: 0;
        }

        /* å¤©æ°”ä¿¡æ¯ä¸»æ ·å¼ (å½“å‰æ¸©åº¦) */
        .city-label .weather-info {
            /* ä¸»æ¸©åº¦åŠ å¤§ã€åŠ ç²— */
            font-size: 15px; 
            font-weight: bold; 
            color: #fff;
            
            line-height: 1.2;
            margin-top: 2px;
            
            /* Flex å¸ƒå±€ä¿è¯å‚ç›´å±…ä¸­å¯¹é½ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* åˆ†éš”ç¬¦æ ·å¼ */
        .weather-divider {
            margin: 0 6px;
            color: var(--accent-color);
            opacity: 0.5;
            font-size: 12px;
            font-weight: normal;
        }

        /* é«˜ä½æ¸©èŒƒå›´æ ·å¼ (å°å­—å·) */
        .temp-range {
            font-size: 11px; /* æ˜æ˜¾æ¯”ä¸»æ¸©åº¦å° */
            font-weight: normal;
            color: #bbb; /* é¢œè‰²ç¨å¾®æš—æ·¡ä¸€ç‚¹ï¼ŒåŒºåˆ†å±‚çº§ */
            font-family: sans-serif; /* ç”¨æ— è¡¬çº¿å­—ä½“è®©æ•°å­—æ›´ç´§å‡‘æ¸…æ™° */
        }

        /* èµ«å°”è¾›åŸºç‰¹åˆ«æ ·å¼ */
        .city-label.highlight {
            border-color: var(--highlight-color);
            border-width: 1px;
            
            /* èµ«å°”è¾›åŸºä¹Ÿç›¸åº”è°ƒé€äº®ä¸€ç‚¹ï¼Œä½†ä¿æŒé†’ç›® */
            background: rgba(40, 0, 15, 0.4); 
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.3);
            
            transform: scale(1.25);
            z-index: 9999 !important;
        }

        .city-label.highlight span.time-display {
            color: #ff3377;
            font-size: 26px;
            text-shadow: 0 0 15px rgba(255, 0, 85, 0.6);
        }
        
        .city-label.highlight strong {
            color: #fff;
            font-size: 12px;
            font-weight: 900;
        }
        
        .city-label.highlight .weather-info {
             color: #ff99bb; /* ä¸»æ¸©åº¦å˜ç²‰è‰² */
        }
        
        .city-label.highlight .temp-range {
            color: #ffcce0; /* èŒƒå›´å˜æ·¡ç²‰è‰² */
        }
        
        .city-label.highlight .weather-divider {
            color: #ff3377;
        }

        /* UI è¦†ç›–å±‚ */
        .overlay-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°åœ°å›¾ */
        }

        .system-status {
            background: rgba(0, 0, 0, 0.4); /* UI é¢æ¿æ›´é€äº® */
            backdrop-filter: blur(5px);
            border: 1px solid rgba(102, 252, 241, 0.2);
            padding: 20px; /* ç¨å¾®å¢åŠ å†…è¾¹è· */
            border-radius: 12px;
            min-width: 200px; /* ç¡®ä¿æœ‰ä¸€å®šå®½åº¦ */
        }

        .blink {
            animation: blinker 1.5s linear infinite;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        /* ç§»é™¤ Leaflet ç‰ˆæƒé“¾æ¥çš„èƒŒæ™¯ä½¿å…¶æ›´èåˆ */
        .leaflet-control-attribution {
            background: rgba(0,0,0,0.2) !important;
            color: #555 !important;
            backdrop-filter: blur(2px);
        }
        .leaflet-control-attribution a {
            color: #777 !important;
        }
    </style>
</head>
<body>

    <!-- UI è¦†ç›–å±‚ -->
    <div class="overlay-ui">
        <div class="system-status">
            <h1 class="text-xl font-bold mb-1" style="color: var(--text-color);">WORLD CLOCK</h1>
            <div class="text-xs text-gray-400 mb-4">LOCATION: HELSINKI</div>
            
            <div id="utc-time" class="text-3xl mt-2 text-white font-bold tracking-wider">UTC: --:--:--</div>
        </div>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>

    <!-- å¼•å…¥ Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // === 1. é…ç½®æ•°æ® ===
        // å®šä¹‰ä¸»è¦åŸå¸‚ï¼Œåæ ‡ï¼Œå’Œ IANA æ—¶åŒºæ ‡è¯†ç¬¦
        const cities = [
            { name: "HELSINKI", lat: 60.1699, lng: 24.9384, tz: "Europe/Helsinki", isHome: true },
            { name: "NEW YORK", lat: 40.7128, lng: -74.0060, tz: "America/New_York" },
            { name: "LONDON", lat: 51.5074, lng: -0.1278, tz: "Europe/London" },
            { name: "TOKYO", lat: 35.6762, lng: 139.6503, tz: "Asia/Tokyo" },
            { name: "BEIJING", lat: 39.9042, lng: 116.4074, tz: "Asia/Shanghai" },
            { name: "SYDNEY", lat: -33.8688, lng: 151.2093, tz: "Australia/Sydney" },
            { name: "DUBAI", lat: 25.2048, lng: 55.2708, tz: "Asia/Dubai" },
            { name: "LOS ANGELES", lat: 34.0522, lng: -118.2437, tz: "America/Los_Angeles" },
            { name: "MOSCOW", lat: 55.7558, lng: 37.6173, tz: "Europe/Moscow" },
            { name: "SINGAPORE", lat: 1.3521, lng: 103.8198, tz: "Asia/Singapore" },
            { name: "SAO PAULO", lat: -23.5505, lng: -46.6333, tz: "America/Sao_Paulo" }
        ];

        // === 2. åˆå§‹åŒ–åœ°å›¾ ===
        // ç¦ç”¨ç¼©æ”¾æ§åˆ¶ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´åƒä¸€ä¸ªä»ªè¡¨ç›˜å£çº¸
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: true,
            zoomSnap: 0.1,
            worldCopyJump: true // å…è®¸åœ°å›¾å·¦å³æ— é™å¾ªç¯
        }).setView([30, 10], 2.5); // åˆå§‹è§†è§’

        // ä½¿ç”¨ CartoDB Dark Matter åº•å›¾ (æ·±è‰²é£æ ¼)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // === 3. æ ‡è®°ç®¡ç†ç³»ç»Ÿ ===
        const markers = {};

        // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡å‡½æ•°
        function createCustomIcon(city, timeStr, dateStr, dayStr) {
            const isHighlight = city.isHome ? 'highlight' : '';
            const cityId = city.name.replace(/\s/g, ''); // ç§»é™¤ç©ºæ ¼ä½œä¸ºID
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="city-label ${isHighlight}">
                        <strong>${city.name}</strong>
                        <span id="time-${cityId}" class="time-display">${timeStr}</span>
                        <div class="date-info">${dayStr} ${dateStr}</div>
                        <div id="weather-${cityId}" class="weather-info">--</div>
                    </div>
                `,
                // è°ƒæ•´ Icon å¤§å°: å®½åº¦å¢åŠ åˆ° 150 ä»¥å®¹çº³æ›´é•¿çš„æ¸©åº¦ä¿¡æ¯ (æœ€é«˜/æœ€ä½)
                iconSize: [150, 85], 
                iconAnchor: [75, 42] // é‡æ–°å±…ä¸­ (150/2 = 75)
            });
        }

        // åˆå§‹åŒ–æ ‡è®°
        cities.forEach(city => {
            const marker = L.marker([city.lat, city.lng], {
                icon: createCustomIcon(city, "--:--", "--", "--"),
                zIndexOffset: city.isHome ? 10000 : 0 // å…³é”®ä¿®æ”¹ï¼šç»™æ‰€åœ¨åŸå¸‚æé«˜çš„å±‚çº§åç§»ï¼Œç¡®ä¿ç‰©ç†ç½®é¡¶
            }).addTo(map);
            
            markers[city.name] = marker;
        });

        // === 4. æ—¶é—´åŒæ­¥ä¸æ›´æ–°é€»è¾‘ ===
        let timeOffset = 0; // ä¸çœŸå®ç½‘ç»œæ—¶é—´çš„åå·®ï¼ˆæ¯«ç§’ï¼‰

        // æ¨¡æ‹Ÿç½‘ç»œæ—¶é—´åŒæ­¥ (çœŸå®è¯·æ±‚)
        async function syncNetworkTime() {
            try {
                // ä½¿ç”¨ WorldTimeAPI è·å–å½“å‰çš„çœŸå® UTC æ—¶é—´
                const response = await fetch('https://worldtimeapi.org/api/ip');
                const data = await response.json();
                
                // è®¡ç®—æœ¬åœ°ç³»ç»Ÿæ—¶é—´ä¸ç½‘ç»œæ—¶é—´çš„åå·®
                const networkTime = new Date(data.utc_datetime).getTime();
                const localTime = new Date().getTime();
                timeOffset = networkTime - localTime;
                
                console.log("Network time synced. Offset:", timeOffset);
                
            } catch (error) {
                console.error("Network Sync Failed, falling back to system time", error);
                timeOffset = 0; // å¤±è´¥åˆ™ä¸è¿›è¡Œåç§»ä¿®æ­£
            }
        }

        // === 5. å¤©æ°”è·å–é€»è¾‘ (Open-Meteo) ===
        
        // æ¢å¤ï¼šWMO å¤©æ°”ä»£ç è½¬ Emoji
        function getWeatherEmoji(code) {
            // 0: Clear sky
            if (code === 0) return "â˜€ï¸";
            // 1, 2, 3: Mainly clear, partly cloudy, and overcast
            if (code >= 1 && code <= 3) return "â˜ï¸";
            // 45, 48: Fog
            if (code >= 45 && code <= 48) return "ğŸŒ«ï¸";
            // 51-67: Drizzle & Rain
            if (code >= 51 && code <= 67) return "ğŸŒ§ï¸";
            // 71-77: Snow
            if (code >= 71 && code <= 77) return "â„ï¸";
            // 80-82: Rain showers
            if (code >= 80 && code <= 82) return "ğŸŒ¦ï¸";
            // 85-86: Snow showers
            if (code >= 85 && code <= 86) return "â„ï¸";
            // 95-99: Thunderstorm
            if (code >= 95) return "â›ˆï¸";
            return "ğŸŒ¡ï¸";
        }

        async function updateWeather() {
            // ç§»é™¤äº† UI çŠ¶æ€æ›´æ–°ä»£ç ï¼Œåªä¿ç•™æ ¸å¿ƒé€»è¾‘
            for (const city of cities) {
                try {
                    // è¯·æ±‚å½“å‰å¤©æ°” + æ¯æ—¥æœ€é«˜/æœ€ä½æ¸© (éœ€è¦æŒ‡å®š timezone ä»¥å‡†ç¡®è·å–å½“å¤©çš„æå€¼)
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lng}&current_weather=true&daily=temperature_2m_max,temperature_2m_min&timezone=${city.tz}`);
                    const data = await res.json();
                    
                    if (data.current_weather && data.daily) {
                        const temp = Math.round(data.current_weather.temperature);
                        const code = data.current_weather.weathercode;
                        const emoji = getWeatherEmoji(code); // è·å– Emoji
                        
                        // è·å–å½“å¤©çš„æœ€é«˜å’Œæœ€ä½æ¸© (æ•°ç»„ç¬¬0é¡¹ä»£è¡¨ä»Šå¤©)
                        const minTemp = Math.round(data.daily.temperature_2m_min[0]);
                        const maxTemp = Math.round(data.daily.temperature_2m_max[0]);

                        // æ›´æ–° DOM
                        const cityId = city.name.replace(/\s/g, '');
                        const weatherEl = document.getElementById(`weather-${cityId}`);
                        if (weatherEl) {
                            // æ ¼å¼ä¼˜åŒ–: Emoji å½“å‰æ¸© <åˆ†éš”ç¬¦> ä½æ¸©/é«˜æ¸©
                            // ä½¿ç”¨ innerHTML ä»¥æ”¯æŒ span æ ·å¼
                            weatherEl.innerHTML = `${emoji} ${temp}Â°C<span class="weather-divider">|</span><span class="temp-range">${minTemp}Â°/${maxTemp}Â°</span>`; 
                        }
                    }
                } catch (e) {
                    console.error(`Failed to fetch weather for ${city.name}`, e);
                }
            }
        }

        // æ ¸å¿ƒæ—¶é’Ÿå¾ªç¯ (æ¯ç§’æ›´æ–°)
        function updateClock() {
            // å½“å‰çœŸå®æ—¶é—´ = æœ¬åœ°æ—¶é—´ + ç½‘ç»œåå·®
            const now = new Date(new Date().getTime() + timeOffset);

            // æ›´æ–° UTC æ˜¾ç¤º
            document.getElementById('utc-time').innerText = "UTC: " + now.toLocaleTimeString('en-US', { timeZone: 'UTC', hour12: false });

            // æ›´æ–°æ¯ä¸ªåŸå¸‚çš„æ ‡è®°
            cities.forEach(city => {
                // ä½¿ç”¨ Intl.DateTimeFormat è·å–ç‰¹å®šæ—¶åŒºçš„æ—¶é—´
                const optionsTime = { 
                    timeZone: city.tz, 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                };
                const optionsDate = { timeZone: city.tz, month: 'short', day: 'numeric' };
                const optionsDay = { timeZone: city.tz, weekday: 'short' };

                const timeStr = new Intl.DateTimeFormat('en-US', optionsTime).format(now);
                const dateStr = new Intl.DateTimeFormat('en-US', optionsDate).format(now);
                const dayStr = new Intl.DateTimeFormat('en-US', optionsDay).format(now).toUpperCase();

                const timeEl = document.getElementById(`time-${city.name.replace(/\s/g, '')}`);
                if (timeEl) {
                    timeEl.innerText = timeStr;
                }
            });
        }

        // å¯åŠ¨ç¨‹åº
        syncNetworkTime(); 
        updateWeather();   
        
        setInterval(updateClock, 1000); 
        setInterval(syncNetworkTime, 600000); 
        setInterval(updateWeather, 1800000); 

        // é€‚é…å±å¹•å¤§å°è°ƒæ•´åœ°å›¾
        window.addEventListener('resize', () => {
            map.invalidateSize();
        });

    </script>
</body>
</html>